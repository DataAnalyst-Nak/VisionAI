<!DOCTYPE html>
<html lang="en">
  <head>
    <title>VisionAI</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-default">
      <div class="container">
        <div class="navbar-header">
          <button
            type="button"
            class="navbar-toggle"
            data-toggle="collapse"
            data-target="#myNavbar"
          >
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#" style="color: #fff"
            >Welcome to VisionAI</a
          >
        </div>
        <div class="collapse navbar-collapse" id="myNavbar">
          <ul class="nav navbar-nav navbar-right">
            <li>
              <a
                href="https://www.linkedin.com/in/rattanak-koem/"
                target="_blank"
                style="color: #fff"
                >About Me</a
              >
            </li>
            <li class="dropdown">
              <a href="#" class="dropbtn" style="color: #fff">AI App ▼</a>
              <ul class="dropdown-content">
                <li>
                  <a
                    href="https://visionai-ojl9.onrender.com/"
                    target="_blank"
                    style="color: #fff"
                    >VisionAI</a
                  >
                </li>
                <li><a href="#" style="color: #fff">FruadSheildAI</a></li>
                <li><a href="#" style="color: #fff">ChurnSheildAI</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropbtn" style="color: #fff">Other App ▼</a>
              <ul class="dropdown-content">
                <li>
                  <a
                    href="https://www.linkedin.com/in/rattanak-koem/"
                    target="_blank"
                    style="color: #fff"
                    >Real-Time Voting System</a
                  >
                </li>
                <li><a href="#" style="color: #fff">POS System</a></li>
                <li><a href="#" style="color: #fff">Hadoop System</a></li>
              </ul>
            </li>
            <li>
              <a
                href="https://www.linkedin.com/in/rattanak-koem/"
                target="_blank"
                style="color: #fff"
                >Contact Us</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- First Container -->
    <div class="container-fluid bg-1 text-center">
      <h3 class="mt-4">VisionAI predicts: <label id="my_output">...</label></h3>

      <div class="thumbnail">
        <img
          id="ip_img"
          class="img-responsive"
          style="display: inline"
          width="250px"
          height="230px"
        />
      </div>
      <form
        action="/"
        method="POST"
        role="form"
        enctype="multipart/form-data"
        id="form1"
      >
        <label
          class="btn btn-lg btn-primary mb-4"
          for="my-file-selector"
          style="background-color: #005b7e; color: white"
        >
          <input
            id="my-file-selector"
            name="my-file-selector"
            type="file"
            style="display: none"
            accept="image/*"
            onchange="my_prediction(this)"
          />
          Upload Image
        </label>
      </form>
      <canvas
        id="myChart"
        style="width: 100%; max-width: 65%; max-height: 260px"
      ></canvas>
    </div>

    <!-- Footer //myChart -->
    <footer class="container-footer bg-4 text-center">
      <p>
        Powered by <strong>VisionAI</strong> &nbsp;|&nbsp; © 2025 All Rights
        Reserved by Rattanak |
        <a href="mailto:rattanakkoem@gmail.com" style="color: #fff"
          >rattanakkoem@gmail.com</a
        >
      </p>
    </footer>

    <script>
      function my_prediction(input) {
        if (input.name == "my-file-selector") {
          if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
              $("#ip_img").attr("src", e.target.result); // to display the image on screen
              call_ajax_to_predict("my-file-selector"); // will call our AI model to predict
              e.preventDefault();
            };
            reader.readAsDataURL(input.files[0]);
          }
        } else {
          console.log("errr");
        }
      }

      let myBarChart = null; // global variable

      function plot_barchart(class_label, class_proba) {
        // Destroy existing chart before creating new
        if (myBarChart) {
          myBarChart.destroy();
        }

        myBarChart = new Chart("myChart", {
          type: "bar",
          data: {
            labels: class_label,
            datasets: [
              {
                backgroundColor: "#005E7B",
                data: class_proba,
              },
            ],
          },
          options: {
            plugins: {
              legend: { display: false }, // Hide legend
              title: {
                display: true,
                text: "Probability of VisionAI's Prediction",
                align: "middle", // left align
                color: "Black",
                font: {
                  size: 17,
                  weight: "bold",
                },
              },
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: {
                  color: "Black",
                  font: { size: 14 },
                },
                title: {
                  display: true,
                  text: "Classes",
                  color: "Black",
                  font: {
                    size: 16,
                    weight: "bold",
                  },
                },
              },
              y: {
                grid: { display: false },
                ticks: {
                  color: "Black",
                  font: { size: 14 },
                },
                title: {
                  display: true,
                  text: "Probability",
                  color: "Black",
                  font: {
                    size: 16,
                    weight: "bold",
                  },
                },
              },
            },
          },
        });
      }

      function call_ajax_to_predict(file_id) {
        var fileInput = document.getElementById(file_id);
        var myFormData = new FormData();
        if (file_id == "my-file-selector") {
          file_obj = fileInput.files[0];
        }

        myFormData.append("file", file_obj);

        $.ajax({
          type: "POST", // define the type of HTTP verb we want to use (POST for our form)
          url: "/", // the url where we want to POST
          data: myFormData, // our data object
          dataType: "json", // what type of data do we expect back from the server
          processData: false,
          contentType: false,
        }).done(function (response) {
          console.log(response);

          if (response.success) {
            const sentence = "";
            const formattedLabel =
              sentence +
              response.label.charAt(0).toUpperCase() +
              response.label.slice(1);
            $("#my_output").text(formattedLabel);
            plot_barchart(response.class_label, response.class_proba);
          }
        });
      }
    </script>
  </body>
</html>
